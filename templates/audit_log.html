{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% block title %}Audit Log – Vehicle Request Tracker{% endblock %}
{% block content %}
<h2 class="mb-3"><i class="bi bi-journal-text"></i> Audit Log</h2>

<!-- ── Filters ──────────────────────────────────────────────────────── -->
<form method="GET" class="row g-2 mb-3 align-items-end">
  <div class="col-auto">
    <label class="form-label mb-0 small text-muted">Entity</label>
    <select class="form-select form-select-sm" name="entity">
      <option value="">All Entities</option>
      {% for e in ['User', 'Vehicle', 'Booking', 'Trip', 'MaintenanceRecord'] %}
        <option value="{{ e }}" {{ 'selected' if current_entity == e }}>{{ e }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label mb-0 small text-muted">Action</label>
    <select class="form-select form-select-sm" name="action">
      <option value="">All Actions</option>
      {% for a in ['create', 'edit', 'delete', 'approve', 'cancel', 'assign', 'complete'] %}
        <option value="{{ a }}" {{ 'selected' if current_action == a }}>{{ a | title }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-sm btn-primary">
      <i class="bi bi-funnel"></i> Filter
    </button>
    <a href="{{ url_for('audit_log') }}" class="btn btn-sm btn-outline-secondary">Clear</a>
  </div>
</form>

{% if logs %}
<div class="table-responsive">
  <table class="table table-sm table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Date &amp; Time</th>
        <th>User</th>
        <th>Action</th>
        <th>Entity</th>
        <th>ID</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td class="text-nowrap">{{ log.timestamp.strftime('%d %b %Y %H:%M:%S') }}</td>
        <td>{{ log.username }}</td>
        <td>
          {% if log.action == 'create' %}
            <span class="badge bg-success">Create</span>
          {% elif log.action == 'edit' %}
            <span class="badge bg-primary">Edit</span>
          {% elif log.action == 'delete' %}
            <span class="badge bg-danger">Delete</span>
          {% elif log.action == 'approve' %}
            <span class="badge bg-info text-dark">Approve</span>
          {% elif log.action == 'cancel' %}
            <span class="badge bg-warning text-dark">Cancel</span>
          {% elif log.action == 'assign' %}
            <span class="badge bg-secondary">Assign</span>
          {% elif log.action == 'complete' %}
            <span class="badge bg-dark">Complete</span>
          {% else %}
            <span class="badge bg-light text-dark">{{ log.action | title }}</span>
          {% endif %}
        </td>
        <td>{{ log.entity_type }}</td>
        <td>{{ log.entity_id if log.entity_id else '–' }}</td>
        <td class="small text-muted">{{ log.details or '–' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<p class="text-muted small">Showing {{ pagination.total }} total entries.</p>
{% else %}
<p class="text-muted">No audit log entries found.</p>
{% endif %}
{{ render_pagination(pagination, 'audit_log', extra_args={'entity': current_entity, 'action': current_action}) }}
{% endblock %}
