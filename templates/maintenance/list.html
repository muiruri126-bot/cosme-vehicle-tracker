{% extends "base.html" %}
{% from "macros/pagination.html" import render_pagination %}
{% block title %}Maintenance – COSME Vehicle Tracker{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2><i class="bi bi-wrench"></i> Vehicle Maintenance</h2>
  {% if current_user.is_admin %}
  <a href="{{ url_for('maintenance_add') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Schedule Maintenance
  </a>
  {% endif %}
</div>

<!-- ── Status filter tabs ───────────────────────────────────────────── -->
<ul class="nav nav-pills mb-3">
  <li class="nav-item">
    <a class="nav-link {{ 'active' if not current_status }}"
       href="{{ url_for('maintenance_list') }}">All</a>
  </li>
  {% for s in ['scheduled', 'in_progress', 'completed', 'cancelled'] %}
  <li class="nav-item">
    <a class="nav-link {{ 'active' if current_status == s }}"
       href="{{ url_for('maintenance_list', status=s) }}">{{ s | replace('_', ' ') | title }}</a>
  </li>
  {% endfor %}
</ul>

{% if records %}
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>#</th>
        <th>Vehicle</th>
        <th>Type</th>
        <th>Description</th>
        <th>Scheduled</th>
        <th>Completed</th>
        <th>Cost</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in records %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.vehicle.registration_number }}</td>
        <td>{{ r.maintenance_type | title }}</td>
        <td>{{ r.description[:60] }}{{ '...' if r.description|length > 60 }}</td>
        <td>{{ r.scheduled_date.strftime('%d %b %Y') }}</td>
        <td>{{ r.completed_date.strftime('%d %b %Y') if r.completed_date else '–' }}</td>
        <td>{{ "%.2f"|format(r.cost) if r.cost else '–' }}</td>
        <td>
          {% if r.status == 'scheduled' %}
            <span class="badge bg-warning text-dark">Scheduled</span>
          {% elif r.status == 'in_progress' %}
            <span class="badge bg-primary">In Progress</span>
          {% elif r.status == 'completed' %}
            <span class="badge bg-success">Completed</span>
          {% else %}
            <span class="badge bg-secondary">{{ r.status | title }}</span>
          {% endif %}
        </td>
        <td>
          {% if current_user.is_admin and r.status in ('scheduled', 'in_progress') %}
          <form method="POST" action="{{ url_for('maintenance_complete', rec_id=r.id) }}"
                class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="cost" value="{{ r.cost or '' }}">
            <button type="submit" class="btn btn-sm btn-success"
                    onclick="return confirm('Mark as completed?')">
              <i class="bi bi-check-lg"></i>
            </button>
          </form>
          <form method="POST" action="{{ url_for('maintenance_cancel', rec_id=r.id) }}"
                class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Cancel this maintenance?')">
              <i class="bi bi-x-lg"></i>
            </button>
          </form>
          {% endif %}
          {% if current_user.is_admin %}
          <form method="POST" action="{{ url_for('maintenance_delete', rec_id=r.id) }}"
                class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-danger"
                    onclick="return confirm('Are you sure you want to permanently delete this maintenance record? This action cannot be undone.')">
              <i class="bi bi-trash"></i>
            </button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">No maintenance records found.</p>
{% endif %}
{{ render_pagination(pagination, 'maintenance_list', extra_args={'status': current_status}) }}
{% endblock %}
