{% extends "base.html" %}
{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2><i class="bi bi-graph-up me-2"></i>Analytics Dashboard</h2>
    <span class="badge bg-secondary fs-6"><i class="bi bi-shield-lock me-1"></i>Admin Only</span>
  </div>

  <!-- ── Summary Cards ─────────────────────────────────────────── -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center card-entrance">
        <div class="card-body">
          <div class="text-primary mb-1"><i class="bi bi-eye fs-3"></i></div>
          <h3 class="mb-0 stat-number">{{ total_views }}</h3>
          <small class="text-muted">Total Page Views</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center card-entrance">
        <div class="card-body">
          <div class="text-success mb-1"><i class="bi bi-calendar-check fs-3"></i></div>
          <h3 class="mb-0 stat-number">{{ today_views }}</h3>
          <small class="text-muted">Today's Views</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center card-entrance">
        <div class="card-body">
          <div class="text-info mb-1"><i class="bi bi-people fs-3"></i></div>
          <h3 class="mb-0 stat-number">{{ total_unique }}</h3>
          <small class="text-muted">Unique Visitors (All Time)</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm text-center card-entrance">
        <div class="card-body">
          <div class="text-warning mb-1"><i class="bi bi-speedometer2 fs-3"></i></div>
          <h3 class="mb-0 stat-number">{{ avg_response }} ms</h3>
          <small class="text-muted">Avg Response Time</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Period breakdown -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="card border-start border-primary border-4 shadow-sm card-entrance">
        <div class="card-body py-2">
          <small class="text-muted">This Week</small>
          <div class="d-flex justify-content-between">
            <strong>{{ week_views }}</strong>
            <span class="text-muted">views</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-start border-success border-4 shadow-sm card-entrance">
        <div class="card-body py-2">
          <small class="text-muted">This Month</small>
          <div class="d-flex justify-content-between">
            <strong>{{ month_views }}</strong>
            <span class="text-muted">views</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-start border-info border-4 shadow-sm card-entrance">
        <div class="card-body py-2">
          <small class="text-muted">Today Unique</small>
          <div class="d-flex justify-content-between">
            <strong>{{ today_unique }}</strong>
            <span class="text-muted">visitors</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-start border-warning border-4 shadow-sm card-entrance">
        <div class="card-body py-2">
          <small class="text-muted">Week Unique</small>
          <div class="d-flex justify-content-between">
            <strong>{{ week_unique }}</strong>
            <span class="text-muted">visitors</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Charts Row ────────────────────────────────────────────── -->
  <div class="row g-3 mb-4">
    <!-- Daily Views Line Chart -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm card-entrance">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-bar-chart-line me-1"></i> Daily Views &amp; Visitors (Last 30 Days)
        </div>
        <div class="card-body">
          <canvas id="dailyChart" height="260"></canvas>
        </div>
      </div>
    </div>
    <!-- Device pie chart -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm card-entrance">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-phone me-1"></i> Device Breakdown
        </div>
        <div class="card-body d-flex align-items-center justify-content-center">
          <canvas id="deviceChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <!-- Hourly Activity Chart -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm card-entrance">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-clock-history me-1"></i> Hourly Activity (Last 7 Days)
        </div>
        <div class="card-body">
          <canvas id="hourlyChart" height="220"></canvas>
        </div>
      </div>
    </div>
    <!-- Browser pie chart -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm card-entrance">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-browser-chrome me-1"></i> Browser Stats
        </div>
        <div class="card-body d-flex align-items-center justify-content-center">
          <canvas id="browserChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Top Pages & Top Users ─────────────────────────────────── -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm card-entrance">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-file-earmark-text me-1"></i> Top Pages (Last 30 Days)
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Page</th>
                  <th class="text-end">Hits</th>
                  <th class="text-end">Unique</th>
                </tr>
              </thead>
              <tbody>
                {% for page in top_pages %}
                <tr class="row-entrance">
                  <td>{{ loop.index }}</td>
                  <td><code>{{ page.path }}</code></td>
                  <td class="text-end">{{ page.hits }}</td>
                  <td class="text-end">{{ page.unique_visitors }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted py-3">No data yet</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm card-entrance">
        <div class="card-header bg-white fw-semibold">
          <i class="bi bi-person-lines-fill me-1"></i> Most Active Users (Last 30 Days)
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>User</th>
                  <th class="text-end">Views</th>
                  <th>Last Seen</th>
                </tr>
              </thead>
              <tbody>
                {% for user in top_users %}
                <tr class="row-entrance">
                  <td>{{ loop.index }}</td>
                  <td>{{ user.username }}</td>
                  <td class="text-end">{{ user.hits }}</td>
                  <td>{{ user.last_seen.strftime('%d %b %Y %H:%M') if user.last_seen else '-' }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted py-3">No data yet</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Recent Activity ───────────────────────────────────────── -->
  <div class="card border-0 shadow-sm card-entrance mb-4">
    <div class="card-header bg-white fw-semibold">
      <i class="bi bi-activity me-1"></i> Recent Page Views (Last 25)
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-sm mb-0" style="font-size: 0.85rem;">
          <thead class="table-light">
            <tr>
              <th>Time</th>
              <th>User</th>
              <th>Page</th>
              <th>Method</th>
              <th>Status</th>
              <th>Device</th>
              <th>Browser</th>
              <th>Response</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody>
            {% for pv in recent_views %}
            <tr class="row-entrance">
              <td class="text-nowrap">{{ pv.timestamp.strftime('%d %b %H:%M:%S') }}</td>
              <td>{{ pv.username or '<span class="text-muted">Anonymous</span>'|safe }}</td>
              <td><code>{{ pv.path }}</code></td>
              <td><span class="badge bg-{{ 'primary' if pv.method == 'GET' else 'warning' }}">{{ pv.method }}</span></td>
              <td>
                <span class="badge bg-{{ 'success' if pv.status_code == 200 else 'warning' if pv.status_code == 302 else 'danger' }}">
                  {{ pv.status_code }}
                </span>
              </td>
              <td><i class="bi bi-{{ 'phone' if pv.device_type == 'mobile' else 'tablet' if pv.device_type == 'tablet' else 'laptop' }}"></i> {{ pv.device_type }}</td>
              <td>{{ pv.browser }}</td>
              <td>{{ pv.response_time_ms|round(1) if pv.response_time_ms else '-' }} ms</td>
              <td class="text-muted">{{ pv.ip_address }}</td>
            </tr>
            {% else %}
            <tr><td colspan="9" class="text-center text-muted py-3">No page views recorded yet</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
// ── Colour palette ──────────────────────────────────────────────
const PLAN_BLUE    = '#004e9a';
const PLAN_YELLOW  = '#ffc107';
const PLAN_GREEN   = '#198754';
const PLAN_RED     = '#dc3545';
const PALETTE = ['#004e9a','#ffc107','#198754','#0dcaf0','#6f42c1','#fd7e14','#dc3545','#20c997'];

// ── Daily Views Chart ───────────────────────────────────────────
new Chart(document.getElementById('dailyChart'), {
  type: 'line',
  data: {
    labels: {{ chart_labels|tojson }},
    datasets: [
      {
        label: 'Page Views',
        data: {{ chart_views|tojson }},
        borderColor: PLAN_BLUE,
        backgroundColor: 'rgba(0,78,154,0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 3,
      },
      {
        label: 'Unique Visitors',
        data: {{ chart_visitors|tojson }},
        borderColor: PLAN_GREEN,
        backgroundColor: 'rgba(25,135,84,0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 3,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'top' } },
    scales: {
      y: { beginAtZero: true, ticks: { precision: 0 } },
      x: { ticks: { maxTicksLimit: 10 } }
    }
  }
});

// ── Device Chart ────────────────────────────────────────────────
new Chart(document.getElementById('deviceChart'), {
  type: 'doughnut',
  data: {
    labels: {{ device_labels|tojson }},
    datasets: [{
      data: {{ device_data|tojson }},
      backgroundColor: PALETTE.slice(0, {{ device_labels|length }}),
      borderWidth: 2,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom' } }
  }
});

// ── Browser Chart ───────────────────────────────────────────────
new Chart(document.getElementById('browserChart'), {
  type: 'doughnut',
  data: {
    labels: {{ browser_labels|tojson }},
    datasets: [{
      data: {{ browser_data|tojson }},
      backgroundColor: PALETTE.slice(0, {{ browser_labels|length }}),
      borderWidth: 2,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom' } }
  }
});

// ── Hourly Chart ────────────────────────────────────────────────
new Chart(document.getElementById('hourlyChart'), {
  type: 'bar',
  data: {
    labels: {{ hourly_labels|tojson }},
    datasets: [{
      label: 'Requests',
      data: {{ hourly_data|tojson }},
      backgroundColor: 'rgba(0,78,154,0.6)',
      borderColor: PLAN_BLUE,
      borderWidth: 1,
      borderRadius: 4,
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      y: { beginAtZero: true, ticks: { precision: 0 } }
    }
  }
});
</script>
{% endblock %}
